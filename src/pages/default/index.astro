---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';

const title = 'usr';
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={title} description={title} />
	</head>
	<body>
		<Header />
		<main class="page" aria-label="File explorer">
			<h1 class="page__title">usr/</h1>
			<ul class="tree" data-root>
				<li class="tree__item tree__item--folder" data-node="projects">
					<button class="tree__label" type="button">
						<span class="tree__chevron" aria-hidden="true">›</span>
						<span class="tree__name">projects/</span>
					</button>
					<ul class="tree__children" hidden data-kind="projects"></ul>
				</li>
				<li class="tree__item tree__item--folder" data-node="exp">
					<button class="tree__label" type="button">
						<span class="tree__chevron" aria-hidden="true">›</span>
						<span class="tree__name">exp/</span>
					</button>
					<ul class="tree__children" hidden>
						<li class="tree__item tree__item--file">resume.txt</li>
					</ul>
				</li>
				<li class="tree__item tree__item--folder" data-node="misc">
					<button class="tree__label" type="button">
						<span class="tree__chevron" aria-hidden="true">›</span>
						<span class="tree__name">misc/</span>
					</button>
					<ul class="tree__children" hidden>
						<li class="tree__item tree__item--file">about.txt</li>
					</ul>
				</li>
			</ul>
		</main>
		<Footer />
		<script is:inline>
			(() => {
				const root = document.querySelector('.tree[data-root]');
				if (!root) return;

				// Ensure dynamically-created nodes receive the same Astro scope attribute
				const scopeAttr = Array.from(root.attributes).find((attr) => attr.name.startsWith('data-astro-cid-'));
				const applyScope = (el) => {
					if (!scopeAttr || !el || !(el instanceof Element)) return;
					el.setAttribute(scopeAttr.name, scopeAttr.value ?? '');
				};

				const toggleFolder = (item) => {
					const children = item.querySelector('.tree__children');
					const label = item.querySelector('.tree__label');
					const chevron = item.querySelector('.tree__chevron');
					if (!children || !label || !chevron) return;

					const isOpen = !children.hidden;
					children.hidden = isOpen;
					item.classList.toggle('is-open', !isOpen);
					chevron.textContent = !isOpen ? '⌄' : '›';
				};

				const CACHE_KEY = 'usr:projects';

				const loadCachedProjects = () => {
					try {
						const raw = sessionStorage.getItem(CACHE_KEY);
						if (!raw) return null;
						const parsed = JSON.parse(raw);
						return Array.isArray(parsed) ? parsed : null;
					} catch {
						return null;
					}
				};

				const saveCachedProjects = (items) => {
					try {
						sessionStorage.setItem(CACHE_KEY, JSON.stringify(items));
					} catch {
						// ignore quota errors
					}
				};

				const hydrateProjects = async (container) => {
					if (!container || container.dataset.loaded === 'true') return;
					container.dataset.loaded = 'true';

					let simplified = loadCachedProjects();
					if (!simplified) {
						try {
							const res = await fetch('https://api.github.com/users/t2ne/repos?per_page=100&sort=updated');
							if (!res.ok) return;
							const repos = await res.json();
							simplified = repos
								.filter((repo) => repo && repo.name && repo.html_url)
								.map((repo) => ({
									name: repo.name,
									url: repo.html_url,
									language: repo.language || 'Other',
								}));
							saveCachedProjects(simplified);
						} catch {
							return;
						}
					}

					const groups = new Map();
					simplified.forEach((repo) => {
						const key = (repo.language || 'Other').toString();
						if (!groups.has(key)) groups.set(key, []);
						groups.get(key).push(repo);
					});

					const languages = Array.from(groups.keys()).sort((a, b) => a.localeCompare(b));

					languages.forEach((language) => {
						const repos = groups.get(language);
						if (!repos || !repos.length) return;

						const item = document.createElement('li');
						item.className = 'tree__item tree__item--folder';
						applyScope(item);

						const button = document.createElement('button');
						button.type = 'button';
						button.className = 'tree__label';
						applyScope(button);

						const chev = document.createElement('span');
						chev.className = 'tree__chevron';
						chev.textContent = '›';
						applyScope(chev);

						const nameSpan = document.createElement('span');
						nameSpan.className = 'tree__name';
						nameSpan.textContent = `${language.toLowerCase()}/`;
						applyScope(nameSpan);

						button.appendChild(chev);
						button.appendChild(nameSpan);

						const childList = document.createElement('ul');
						childList.className = 'tree__children';
						childList.hidden = true;
						applyScope(childList);

						repos.forEach((repo) => {
							const li = document.createElement('li');
							li.className = 'tree__item tree__item--file';
							applyScope(li);
							const link = document.createElement('a');
							link.href = repo.url;
							link.target = '_blank';
							link.rel = 'noreferrer';
							link.textContent = repo.name;
							applyScope(link);
							li.appendChild(link);
							childList.appendChild(li);
						});

						item.appendChild(button);
						item.appendChild(childList);
						container.appendChild(item);
					});
				};

				root.addEventListener('click', (event) => {
					const target = event.target;
					if (!(target instanceof Element)) return;
					const label = target.closest('.tree__label');
					if (!label) return;
					const item = label.closest('.tree__item');
					if (!item) return;

					const children = item.querySelector('.tree__children');
					if (children && children.dataset.kind === 'projects') {
						hydrateProjects(children);
					}

					toggleFolder(item);
				});
			})();
		</script>

		<style>
			.page {
				min-height: 100vh;
				padding: 90px 28px 84px 28px;
			}
			.page__title {
				font-size: 16px;
				font-weight: 400;
				margin: 0 0 18px 0;
				color: var(--desktop-label);
			}
			.tree {
				list-style: none;
				margin: 0;
				padding: 0;
				font-size: 14px;
			}
			.tree__item {
				position: relative;
				margin: 4px 0;
				list-style: none;
			}
			.tree__label {
				border: 0;
				border-radius: 0;
				background: none;
				box-shadow: none;
				color: var(--desktop-label);
				font: inherit;
				padding: 0;
				margin: 0;
				cursor: pointer;
				text-align: left;
				appearance: none;
				-webkit-appearance: none;
			}
			.tree__label:hover {
				text-decoration: underline;
			}
			.tree__chevron {
				display: inline-block;
				width: 1ch;
				margin-right: 6px;
			}
			.tree__name {
				letter-spacing: 0.02em;
			}
			.tree__children {
				list-style: none;
				margin: 0;
				padding: 0 0 0 20px;
				border-left: 1px solid var(--border);
			}
			.tree__children .tree__item::before {
				content: '';
				position: absolute;
				left: -20px;
				width: 20px;
				top: 0.9em;
				border-bottom: 1px solid var(--border);
			}
			.tree__item--file a,
			.tree__item--file {
				color: var(--desktop-label);
				font-size: 13px;
				text-decoration: none;
			}
			.tree__item--file a:hover {
				text-decoration: underline;
			}
		</style>
	</body>
</html>
